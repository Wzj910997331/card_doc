
## AXCL 安装加载

我们提供x86版本的ubuntu22.04和arm64版本的Raspbian的deb包以及x86版本centos9的rmp包。百度网盘获取方式联系*淘宝客服*或者*芯茧技术支持*。


### deb和rpm包安装

#### deb包安装脚本

   ``` bash
   #!/bin/sh
   set -e
   home=$(pwd)/..
   axcl=${home}/usr/src/axcl/drv/pcie/driver/
   ko=${home}/usr/src/axcl/out/axcl_linux_x86/ko
   image=${home}/usr/src/axcl/image
   modules=/lib/modules/$(uname -r)/extra

   # Compile driver
   cd ${axcl}
   make host=x86 clean all install -j8 >/dev/null 2>&1

   # install driver
   mkdir -p ${modules}
   cp -rf ${ko}/ax_pcie_host_dev.ko ${modules}
   cp -rf ${ko}/ax_pcie_msg.ko ${modules}
   cp -rf ${ko}/ax_pcie_mmb.ko ${modules}
   cp -rf ${ko}/axcl_host.ko ${modules}

   # install image
   mkdir -p /lib/firmware/axcl
   cp -rf ${image}/ax650_card.pac /lib/firmware/axcl/

   # update modules
   depmod -a

   # update so config
   ldconfig

   # insmod ko
   modprobe ax_pcie_host_dev
   modprobe ax_pcie_msg
   modprobe ax_pcie_mmb
   modprobe axcl_host
   set +e

   AXCL_BIN_PATH=$(echo $PATH | grep -c '/usr/bin/axcl')
   if [ $AXCL_BIN_PATH -eq 0 ]; then
      echo "\e[1;31mNeed manual execute: source /etc/profile\e[0m"
   fi

   exit 0
   ```

#### deb 安装

1.  `chmod +x` 给deb添加执行权限

   ```bash
    [axera@localhost ~]$ chmod +x axcl_host_V2.16.1_20241112130139_NO4433.deb
   ```

2. `sudo dpkg -i`  安装deb，安装完之后自动加载子卡固件。

   ```bash
   [axera@localhost ~]$ sudo dpkg -i axcl_host_V2.16.1_20241112130139_NO4433.deb
   输入密码          
   (正在读取数据库 ... 系统当前共安装有 202167 个文件和目录。)
   准备解压 axcl_host_V2.16.1_20241112130139_NO4433.deb  ...
   正在解压 axclhost (1.0) 并覆盖 (1.0) ...
   正在设置 axclhost (1.0) ...
   Need manual execute: source /etc/profile
   正在处理用于 libc-bin (2.31-0kylin9.2k0.2) 的触发器 ...
   ```

3.  执行`source /etc/profile`更新环境变量

   ```bash
   [axera@localhost ~]$ source /etc/profile
   ```

#### deb 卸载

```bash
[axera@localhost ~]$ sudo dpkg -r axclhost
(正在读取数据库 ... 系统当前共安装有 198866 个文件和目录。)
正在卸载 axclhost (1.0) ...
正在处理用于 libc-bin (2.31-0kylin9.2k0.2) 的触发器 ...
```

#### rpm安装脚本

   rmp包安装类似于deb包安装脚本，这个不再复述。

#### rpm 安装

1.  `chmod +x` 给rpm添加执行权限

   ```bash
    [axera@localhost ~]$ chmod +x axcl_host-1.0-1.el9.x86_64.rpm
   ```

2. `sudo rpm -Uvh --nodeps`  安装rpm，安装完之后自动加载子卡固件。

   ```bash
   [axera@localhost rpmbuild]$ sudo rpm -Uvh --nodeps RPMS/x86_64/axcl_host-1.0-1.el9.x86_64.rpm
   [sudo] password for axera:
   Verifying...                          ################################# [100%]
   Preparing...                          ################################# [100%]
   Updating / installing...
      1:axcl_host-1.0-1.el9              ################################# [100%]
   [axera@localhost rpmbuild]$
   ```

对于 `ssh` 的连接，还可以通过断开重连的方式更新环境。下列目录是 rpm 包安装的主要内容：

   ```bash
   [axera@localhost axcl]$ ls  /usr/lib/axcl/
   ffmpeg                libaxcl_ive.so      libaxcl_npu.so          libaxcl_pkg.so     libaxcl_skel.debug   libaxcl_vdec.debug  libspdlog.so.1.14.1
   libaxcl_comm.debug    libaxcl_ivps.debug  libaxcl_pcie_dma.debug  libaxcl_ppl.debug  libaxcl_skel.so      libaxcl_vdec.so
   libaxcl_comm.so       libaxcl_ivps.so     libaxcl_pcie_dma.so     libaxcl_ppl.so     libaxcl_sys.debug    libaxcl_venc.debug
   libaxcl_dmadim.debug  libaxcl_lite.debug  libaxcl_pcie_msg.debug  libaxcl_proto.a    libaxcl_sys.so       libaxcl_venc.so
   libaxcl_dmadim.so     libaxcl_lite.so     libaxcl_pcie_msg.so     libaxcl_rt.debug   libaxcl_token.debug  libspdlog.so
   libaxcl_ive.debug     libaxcl_npu.debug   libaxcl_pkg.debug       libaxcl_rt.so      libaxcl_token.so     libspdlog.so.1.14
   [axera@localhost axcl]$ ls  /usr/bin/axcl/
   axcl_demo       axcl_sample_dmadim  axcl_sample_ivps    axcl_sample_runtime  axcl_sample_sys        axcl_sample_vdec  axcl_smi  launch_transcode.sh
   axcl_run_model  axcl_sample_ive     axcl_sample_memory  axcl_sample_skel     axcl_sample_transcode  axcl_sample_venc  data      ut
   ```

3.  执行`source /etc/profile`更新环境变量

   ```bash
   [axera@localhost ~]$ source /etc/profile
   ```

#### rpm 卸载

rpm 包卸载后会自动 reset 子卡，子卡会进入 `pcie download mode`。卸载命令如下：

   ```bash
   sudo rpm -e axcl_host
   ```


### 自定义BSP驱动编译安装

这里以ubuntu x86环境为例，讲解如何解决自定义BSP编译驱动问题。

1. 解压deb包

   ``` shell
   dpkg-deb -X axcl_host_x86_64_V2.18.0_20241204174017_NO4482.deb test_deb
   cd test_deb/ && tree -L 2
   .
   ├── etc
   │   ├── ld.so.conf.d
   │   ├── modules-load.d
   │   ├── profile.d
   │   └── udev
   ├── lib
   │   └── firmware
   └── usr
      ├── bin
      ├── include
      ├── lib
      └── src
   ```

2. 编译驱动

   ``` shell
   cd drv/pcie/driver/; patch -p3 < pcie_proc.patch; cd -
   make host=x86 clean all install -C drv/pcie/driver
   ##出现4个ko文件，说明编译成功
   ls out/axcl_linux_x86/ko/
   axcl_host.ko  ax_pcie_host_dev.ko  ax_pcie_mmb.ko  ax_pcie_msg.ko  ax_pcie_net_host.ko
   ```

3. 安装算力卡固件：

   ```bash
   sudo mkdir -p /lib/firmware/axcl
   sudo cp -rf image/ax650_card.pac /lib/firmware/axcl/
   ```

4. 加载驱动(启动算力卡)：

   ```bash
   sudo insmod out/axcl_linux_x86/ko/ax_pcie_host_dev.ko
   sudo insmod out/axcl_linux_x86/ko/ax_pcie_msg.ko
   sudo insmod out/axcl_linux_x86/ko/ax_pcie_mmb.ko
   sudo insmod out/axcl_linux_x86/ko/axcl_host.ko
   sudo chmod 666 /dev/msg_userdev
   sudo chmod 666 /dev/ax_mmb_dev
   sudo chmod 666 /dev/axcl_host
   ```

5.  AXCL 源码编译
   若deb默认编译好可执行程序，这一步可以不执行。

   ```bash
   cd <axcl>/build
   make host=x86 clean all install -j8
   # 编译后的文件目录 
   # <axcl>/out/axcl_linux_x86
   # <axcl>/out/axcl_linux_x86/bin : 存放demo程序
   # <axcl>/out/axcl_linux_x86/lib : 存放axcl库

   # 添加axcl库的路径
   cd <axcl>
   export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PWD/out/axcl_linux_x86/lib/:$PWD/out/axcl_linux_x86/lib/ffmpeg/
   ```